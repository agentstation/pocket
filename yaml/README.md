# YAML Package

The `yaml` package provides YAML integration for Pocket workflows. It enables declarative workflow definition, YAML-based configuration, and structured output formatting for better LLM interaction.

## Features

- **Declarative workflow definitions** in YAML
- **YAML node creation** for structured output
- **Workflow loading** from YAML files
- **Schema validation** for YAML workflows
- **Type-safe parsing** with proper error handling

## Usage Example

```go
import "github.com/agentstation/pocket/yaml"

// Load workflow from YAML file
loader := yaml.NewLoader()
graph, err := loader.LoadFile("workflow.yaml", store)

// Create YAML output node
yamlNode := yaml.YAMLNode("formatter",
    pocket.WithExec(func(ctx context.Context, input any) (any, error) {
        return map[string]any{
            "result": "processed",
            "confidence": 0.95,
            "metadata": map[string]any{
                "timestamp": time.Now(),
                "version": "1.0",
            },
        }, nil
    }),
)
```

## YAML Workflow Format

```yaml
name: example-workflow
start: validate
nodes:
  - name: validate
    type: validator
    config:
      rules:
        - required: true
        - min_length: 10
    routes:
      valid: process
      invalid: error-handler

  - name: process
    type: processor
    config:
      mode: parallel
      timeout: 30s
    routes:
      success: notify
      failure: error-handler

  - name: notify
    type: notifier
    config:
      channels:
        - email
        - slack
```

## Benefits for LLM Integration

- **Structured Output**: YAML format is easily parsed by LLMs
- **Clear Semantics**: Declarative format improves LLM understanding
- **Version Control**: YAML workflows are diff-friendly
- **Composability**: Workflows can include other YAML files

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# yaml

```go
import "github.com/agentstation/pocket/yaml"
```

Package yaml provides YAML\-based workflow definition and loading capabilities, enabling configuration\-driven graph construction.

Package yaml provides YAML\-based graph definition support for pocket.

<details><summary>Example</summary>
<p>

Example shows what a YAML graph definition would look like.

```go
package main

import (
	"bytes"
	"fmt"
	"io"
	"os"
)

// Parser handles parsing YAML graph definitions.
type Parser struct {
	// Future: Add schema validation, custom marshalers, etc.
}

// NewParser creates a new YAML parser.
func NewParser() *Parser {
	return &Parser{}
}

// Parse reads and parses a YAML graph definition from a reader.
func (p *Parser) Parse(r io.Reader) (*GraphDefinition, error) {
	// Note: We're not importing yaml.v3 to keep the package dependency-free.
	// This is a placeholder that would need a YAML library in practice.
	// For now, we'll return an error indicating YAML support needs to be enabled.
	return nil, fmt.Errorf("YAML parsing requires importing a YAML library (e.g., github.com/goccy/go-yaml)")
}

// ParseFile reads and parses a YAML graph definition from a file.
func (p *Parser) ParseFile(filename string) (*GraphDefinition, error) {
	// #nosec G304 - This is a parser that needs to accept arbitrary file paths
	// In production, callers should validate the path based on their security requirements
	file, err := os.Open(filename)
	if err != nil {
		return nil, fmt.Errorf("open file: %w", err)
	}
	defer func() { _ = file.Close() }()

	return p.Parse(file)
}

// ParseString parses a YAML graph definition from a string.
func (p *Parser) ParseString(s string) (*GraphDefinition, error) {
	return p.Parse(bytes.NewReader([]byte(s)))
}

// Marshal converts a graph definition to YAML format.
func (p *Parser) Marshal(gd *GraphDefinition) ([]byte, error) {
	// Placeholder - would use YAML library
	return nil, fmt.Errorf("YAML marshaling requires importing a YAML library")
}

// MarshalToFile writes a graph definition to a YAML file.
func (p *Parser) MarshalToFile(gd *GraphDefinition, filename string) error {
	data, err := p.Marshal(gd)
	if err != nil {
		return err
	}

	return os.WriteFile(filename, data, 0o600)
}

// Example shows what a YAML graph definition would look like.
func main() string {
	return `name: chat_workflow
description: Multi-agent chat workflow with routing
version: "1.0.0"
start: input_validator

nodes:
  - name: input_validator
    type: validator
    config:
      required_fields: ["message", "user_id"]
    timeout: 5s
    
  - name: intent_classifier
    type: llm
    config:
      model: "gpt-4"
      prompt: "Classify the intent of this message: {{.message}}"
    retry:
      max_attempts: 3
      delay: 1s
      multiplier: 2
      
  - name: knowledge_search
    type: rag
    config:
      index: "knowledge_base"
      top_k: 5
      
  - name: response_generator
    type: llm
    config:
      model: "gpt-4"
      prompt: "Generate a response based on: {{.context}}"
      
  - name: output_formatter
    type: formatter
    config:
      format: "markdown"

connections:
  - from: input_validator
    to: intent_classifier
    action: valid
    
  - from: intent_classifier
    to: knowledge_search
    action: needs_info
    
  - from: intent_classifier
    to: response_generator
    action: direct_response
    
  - from: knowledge_search
    to: response_generator
    action: default
    
  - from: response_generator
    to: output_formatter
    action: default
`
}
```

</p>
</details>

## Index

- [func Example\(\) string](<#Example>)
- [func FromYAML\(yamlStr string, target any\) error](<#FromYAML>)
- [func LLMNodeBuilder\(def \*NodeDefinition\) \(pocket.Node, error\)](<#LLMNodeBuilder>)
- [func ToYAML\(data any\) \(string, error\)](<#ToYAML>)
- [func ValidatorNodeBuilder\(def \*NodeDefinition\) \(pocket.Node, error\)](<#ValidatorNodeBuilder>)
- [func YAMLNode\(name string, execFn pocket.ExecFunc\) pocket.Node](<#YAMLNode>)
- [func YAMLNodeWithLifecycle\(name string, prep pocket.PrepFunc, exec pocket.ExecFunc, post pocket.PostFunc\) pocket.Node](<#YAMLNodeWithLifecycle>)
- [type Connection](<#Connection>)
- [type GraphDefinition](<#GraphDefinition>)
  - [func \(gd \*GraphDefinition\) Validate\(\) error](<#GraphDefinition.Validate>)
- [type Loader](<#Loader>)
  - [func NewLoader\(\) \*Loader](<#NewLoader>)
  - [func \(l \*Loader\) LoadDefinition\(def \*GraphDefinition, store pocket.Store\) \(\*pocket.Graph, error\)](<#Loader.LoadDefinition>)
  - [func \(l \*Loader\) LoadFile\(filename string, store pocket.Store\) \(\*pocket.Graph, error\)](<#Loader.LoadFile>)
  - [func \(l \*Loader\) LoadString\(yamlStr string, store pocket.Store\) \(\*pocket.Graph, error\)](<#Loader.LoadString>)
  - [func \(l \*Loader\) RegisterNodeType\(nodeType string, builder NodeBuilder\)](<#Loader.RegisterNodeType>)
  - [func \(l \*Loader\) WithNodeFactory\(factory NodeFactory\) \*Loader](<#Loader.WithNodeFactory>)
- [type NodeBuilder](<#NodeBuilder>)
- [type NodeDefinition](<#NodeDefinition>)
  - [func \(nd \*NodeDefinition\) GetTimeout\(\) \(time.Duration, error\)](<#NodeDefinition.GetTimeout>)
  - [func \(nd \*NodeDefinition\) Validate\(\) error](<#NodeDefinition.Validate>)
- [type NodeFactory](<#NodeFactory>)
- [type Parser](<#Parser>)
  - [func NewParser\(\) \*Parser](<#NewParser>)
  - [func \(p \*Parser\) Marshal\(gd \*GraphDefinition\) \(\[\]byte, error\)](<#Parser.Marshal>)
  - [func \(p \*Parser\) MarshalToFile\(gd \*GraphDefinition, filename string\) error](<#Parser.MarshalToFile>)
  - [func \(p \*Parser\) Parse\(r io.Reader\) \(\*GraphDefinition, error\)](<#Parser.Parse>)
  - [func \(p \*Parser\) ParseFile\(filename string\) \(\*GraphDefinition, error\)](<#Parser.ParseFile>)
  - [func \(p \*Parser\) ParseString\(s string\) \(\*GraphDefinition, error\)](<#Parser.ParseString>)
- [type RetryConfig](<#RetryConfig>)
  - [func \(rc \*RetryConfig\) GetMaxDelay\(\) \(time.Duration, error\)](<#RetryConfig.GetMaxDelay>)
  - [func \(rc \*RetryConfig\) GetRetryDelay\(\) \(time.Duration, error\)](<#RetryConfig.GetRetryDelay>)
  - [func \(rc \*RetryConfig\) Validate\(\) error](<#RetryConfig.Validate>)
- [type YAMLOutput](<#YAMLOutput>)
  - [func \(y YAMLOutput\) String\(\) string](<#YAMLOutput.String>)


<a name="Example"></a>
## func [Example](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L63>)

```go
func Example() string
```

Example shows what a YAML graph definition would look like.

<a name="FromYAML"></a>
## func [FromYAML](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L134>)

```go
func FromYAML(yamlStr string, target any) error
```

FromYAML parses YAML string into the target structure.

<a name="LLMNodeBuilder"></a>
## func [LLMNodeBuilder](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L261>)

```go
func LLMNodeBuilder(def *NodeDefinition) (pocket.Node, error)
```

LLMNodeBuilder creates an LLM node from a definition.

<a name="ToYAML"></a>
## func [ToYAML](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L125>)

```go
func ToYAML(data any) (string, error)
```

ToYAML converts any data to YAML string.

<a name="ValidatorNodeBuilder"></a>
## func [ValidatorNodeBuilder](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L276>)

```go
func ValidatorNodeBuilder(def *NodeDefinition) (pocket.Node, error)
```

ValidatorNodeBuilder creates a validator node.

<a name="YAMLNode"></a>
## func [YAMLNode](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L15>)

```go
func YAMLNode(name string, execFn pocket.ExecFunc) pocket.Node
```

YAMLNode creates a node that marshals its output to YAML format. If execFn is provided, it wraps the function to marshal its output as YAML. If execFn is nil, the node will marshal its input as YAML.

<a name="YAMLNodeWithLifecycle"></a>
## func [YAMLNodeWithLifecycle](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L55>)

```go
func YAMLNodeWithLifecycle(name string, prep pocket.PrepFunc, exec pocket.ExecFunc, post pocket.PostFunc) pocket.Node
```

YAMLNodeWithLifecycle creates a YAML node with full lifecycle support. The exec function's output will be marshaled to YAML.

<a name="Connection"></a>
## type [Connection](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L33-L37>)

Connection represents a connection between nodes.

```go
type Connection struct {
    From   string `yaml:"from"`
    To     string `yaml:"to"`
    Action string `yaml:"action,omitempty"`
}
```

<a name="GraphDefinition"></a>
## type [GraphDefinition](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L10-L18>)

GraphDefinition represents a complete graph defined in YAML.

```go
type GraphDefinition struct {
    Name        string                 `yaml:"name"`
    Description string                 `yaml:"description,omitempty"`
    Version     string                 `yaml:"version,omitempty"`
    Metadata    map[string]interface{} `yaml:"metadata,omitempty"`
    Nodes       []NodeDefinition       `yaml:"nodes"`
    Connections []Connection           `yaml:"connections,omitempty"`
    Start       string                 `yaml:"start"`
}
```

<a name="GraphDefinition.Validate"></a>
### func \(\*GraphDefinition\) [Validate](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L48>)

```go
func (gd *GraphDefinition) Validate() error
```

Validate checks if the graph definition is valid.

<a name="Loader"></a>
## type [Loader](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L31-L34>)

Loader loads graph definitions and creates executable graphs.

```go
type Loader struct {
    // contains filtered or unexported fields
}
```

<a name="NewLoader"></a>
### func [NewLoader](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L37>)

```go
func NewLoader() *Loader
```

NewLoader creates a new YAML graph loader.

<a name="Loader.LoadDefinition"></a>
### func \(\*Loader\) [LoadDefinition](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L80>)

```go
func (l *Loader) LoadDefinition(def *GraphDefinition, store pocket.Store) (*pocket.Graph, error)
```

LoadDefinition creates a graph from a parsed definition.

<a name="Loader.LoadFile"></a>
### func \(\*Loader\) [LoadFile](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L60>)

```go
func (l *Loader) LoadFile(filename string, store pocket.Store) (*pocket.Graph, error)
```

LoadFile loads a graph from a YAML file.

<a name="Loader.LoadString"></a>
### func \(\*Loader\) [LoadString](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L70>)

```go
func (l *Loader) LoadString(yamlStr string, store pocket.Store) (*pocket.Graph, error)
```

LoadString loads a graph from a YAML string.

<a name="Loader.RegisterNodeType"></a>
### func \(\*Loader\) [RegisterNodeType](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L53>)

```go
func (l *Loader) RegisterNodeType(nodeType string, builder NodeBuilder)
```

RegisterNodeType registers a builder for a node type.

<a name="Loader.WithNodeFactory"></a>
### func \(\*Loader\) [WithNodeFactory](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L47>)

```go
func (l *Loader) WithNodeFactory(factory NodeFactory) *Loader
```

WithNodeFactory sets a custom node factory.

<a name="NodeBuilder"></a>
## type [NodeBuilder](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L28>)

NodeBuilder is a function that builds a node from a definition.

```go
type NodeBuilder func(def *NodeDefinition) (pocket.Node, error)
```

<a name="NodeDefinition"></a>
## type [NodeDefinition](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L21-L30>)

NodeDefinition represents a node in YAML format.

```go
type NodeDefinition struct {
    Name        string                 `yaml:"name"`
    Type        string                 `yaml:"type"`
    Description string                 `yaml:"description,omitempty"`
    Config      map[string]interface{} `yaml:"config,omitempty"`
    Retry       *RetryConfig           `yaml:"retry,omitempty"`
    Timeout     string                 `yaml:"timeout,omitempty"`
    InputType   string                 `yaml:"input_type,omitempty"`
    OutputType  string                 `yaml:"output_type,omitempty"`
}
```

<a name="NodeDefinition.GetTimeout"></a>
### func \(\*NodeDefinition\) [GetTimeout](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L141>)

```go
func (nd *NodeDefinition) GetTimeout() (time.Duration, error)
```

GetTimeout returns the parsed timeout duration.

<a name="NodeDefinition.Validate"></a>
### func \(\*NodeDefinition\) [Validate](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L96>)

```go
func (nd *NodeDefinition) Validate() error
```

Validate checks if the node definition is valid.

<a name="NodeFactory"></a>
## type [NodeFactory](<https://github.com/agentstation/pocket/blob/master/yaml/loader.go#L18-L20>)

NodeFactory creates nodes from definitions.

```go
type NodeFactory interface {
    CreateNode(def *NodeDefinition) (pocket.Node, error)
}
```

<a name="Parser"></a>
## type [Parser](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L11-L13>)

Parser handles parsing YAML graph definitions.

```go
type Parser struct {
}
```

<a name="NewParser"></a>
### func [NewParser](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L16>)

```go
func NewParser() *Parser
```

NewParser creates a new YAML parser.

<a name="Parser.Marshal"></a>
### func \(\*Parser\) [Marshal](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L47>)

```go
func (p *Parser) Marshal(gd *GraphDefinition) ([]byte, error)
```

Marshal converts a graph definition to YAML format.

<a name="Parser.MarshalToFile"></a>
### func \(\*Parser\) [MarshalToFile](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L53>)

```go
func (p *Parser) MarshalToFile(gd *GraphDefinition, filename string) error
```

MarshalToFile writes a graph definition to a YAML file.

<a name="Parser.Parse"></a>
### func \(\*Parser\) [Parse](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L21>)

```go
func (p *Parser) Parse(r io.Reader) (*GraphDefinition, error)
```

Parse reads and parses a YAML graph definition from a reader.

<a name="Parser.ParseFile"></a>
### func \(\*Parser\) [ParseFile](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L29>)

```go
func (p *Parser) ParseFile(filename string) (*GraphDefinition, error)
```

ParseFile reads and parses a YAML graph definition from a file.

<a name="Parser.ParseString"></a>
### func \(\*Parser\) [ParseString](<https://github.com/agentstation/pocket/blob/master/yaml/parser.go#L42>)

```go
func (p *Parser) ParseString(s string) (*GraphDefinition, error)
```

ParseString parses a YAML graph definition from a string.

<a name="RetryConfig"></a>
## type [RetryConfig](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L40-L45>)

RetryConfig represents retry configuration in YAML.

```go
type RetryConfig struct {
    MaxAttempts int     `yaml:"max_attempts"`
    Delay       string  `yaml:"delay"`
    Multiplier  float64 `yaml:"multiplier,omitempty"`
    MaxDelay    string  `yaml:"max_delay,omitempty"`
}
```

<a name="RetryConfig.GetMaxDelay"></a>
### func \(\*RetryConfig\) [GetMaxDelay](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L154>)

```go
func (rc *RetryConfig) GetMaxDelay() (time.Duration, error)
```

GetMaxDelay returns the parsed max delay duration.

<a name="RetryConfig.GetRetryDelay"></a>
### func \(\*RetryConfig\) [GetRetryDelay](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L149>)

```go
func (rc *RetryConfig) GetRetryDelay() (time.Duration, error)
```

GetRetryDelay returns the parsed retry delay duration.

<a name="RetryConfig.Validate"></a>
### func \(\*RetryConfig\) [Validate](<https://github.com/agentstation/pocket/blob/master/yaml/schema.go#L115>)

```go
func (rc *RetryConfig) Validate() error
```

Validate checks if the retry config is valid.

<a name="YAMLOutput"></a>
## type [YAMLOutput](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L113-L117>)

YAMLOutput represents structured output in YAML format.

```go
type YAMLOutput struct {
    YAML   string
    Data   any
    Format string
}
```

<a name="YAMLOutput.String"></a>
### func \(YAMLOutput\) [String](<https://github.com/agentstation/pocket/blob/master/yaml/output.go#L120>)

```go
func (y YAMLOutput) String() string
```

String returns the YAML representation.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->