# Middleware Package

The `middleware` package provides cross-cutting concerns for Pocket workflows including logging, metrics, timing, and tracing. Middleware can be applied at both node and graph levels.

## Features

- **Logging middleware** with structured output
- **Metrics collection** for monitoring
- **Timing middleware** for performance tracking
- **Tracing support** for distributed systems
- **Custom middleware** creation support

## Usage Example

```go
import "github.com/agentstation/pocket/middleware"

// Apply logging middleware
node := pocket.NewNode[Input, Output]("processor",
    pocket.WithExec(processFunc),
    middleware.WithLogging(logger),
)

// Add timing middleware
timedNode := middleware.WithTiming(node, func(duration time.Duration) {
    metrics.RecordDuration("node.execution", duration)
})

// Chain multiple middleware
wrapped := middleware.Chain(node,
    middleware.WithLogging(logger),
    middleware.WithMetrics(collector),
    middleware.WithTracing(tracer),
)
```

## Creating Custom Middleware

```go
func WithCustom(next pocket.Node) pocket.Node {
    return middleware.Wrap(next, func(ctx context.Context, input any) (any, error) {
        // Pre-execution logic
        start := time.Now()
        
        // Execute wrapped node
        result, err := next.Execute(ctx, input)
        
        // Post-execution logic
        log.Printf("Execution took: %v", time.Since(start))
        
        return result, err
    })
}
```

## Common Patterns

### Request ID Tracking
```go
middleware.WithRequestID(func(ctx context.Context, reqID string) {
    log.Printf("Processing request: %s", reqID)
})
```

### Circuit Breaking
```go
middleware.WithCircuitBreaker(
    middleware.CircuitBreakerConfig{
        FailureThreshold: 5,
        ResetTimeout:     30 * time.Second,
    },
)
```

### Rate Limiting
```go
middleware.WithRateLimit(
    middleware.RateLimitConfig{
        RequestsPerSecond: 100,
        BurstSize:         10,
    },
)
```

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# middleware

```go
import "github.com/agentstation/pocket/middleware"
```

Package middleware provides node enhancement patterns for cross\-cutting concerns like logging, metrics, retries, and circuit breakers.

## Index

- [func Apply\(node pocket.Node, middlewares ...Middleware\) pocket.Node](<#Apply>)
- [type MetricsCollector](<#MetricsCollector>)
- [type Middleware](<#Middleware>)
  - [func Chain\(middlewares ...Middleware\) Middleware](<#Chain>)
  - [func CircuitBreaker\(threshold int, timeout time.Duration\) Middleware](<#CircuitBreaker>)
  - [func ErrorHandler\(handler func\(error\) error\) Middleware](<#ErrorHandler>)
  - [func Logging\(logger pocket.Logger\) Middleware](<#Logging>)
  - [func Metrics\(collector MetricsCollector\) Middleware](<#Metrics>)
  - [func RateLimit\(rps, burst int\) Middleware](<#RateLimit>)
  - [func Retry\(maxAttempts int, backoff time.Duration\) Middleware](<#Retry>)
  - [func Timeout\(duration time.Duration\) Middleware](<#Timeout>)
  - [func Timing\(\) Middleware](<#Timing>)
  - [func Transform\(transformInput, transformOutput func\(any\) any\) Middleware](<#Transform>)
  - [func Validation\(validateInput, validateOutput func\(any\) error\) Middleware](<#Validation>)


<a name="Apply"></a>
## func [Apply](<https://github.com/agentstation/pocket/blob/master/middleware/middleware.go#L77>)

```go
func Apply(node pocket.Node, middlewares ...Middleware) pocket.Node
```

Apply applies middleware to a node.

<a name="MetricsCollector"></a>
## type [MetricsCollector](<https://github.com/agentstation/pocket/blob/master/middleware/metrics.go#L10-L14>)

MetricsCollector collects node execution metrics.

```go
type MetricsCollector interface {
    RecordPhaseStart(nodeName, phase string)
    RecordPhaseEnd(nodeName, phase string, err error)
    RecordRouting(nodeName, next string)
}
```

<a name="Middleware"></a>
## type [Middleware](<https://github.com/agentstation/pocket/blob/master/middleware/middleware.go#L13>)

Middleware modifies node behavior.

```go
type Middleware func(pocket.Node) pocket.Node
```

<a name="Chain"></a>
### func [Chain](<https://github.com/agentstation/pocket/blob/master/middleware/middleware.go#L67>)

```go
func Chain(middlewares ...Middleware) Middleware
```

Chain combines multiple middlewares into a single middleware. Middlewares are applied in reverse order \(like function composition\).

<a name="CircuitBreaker"></a>
### func [CircuitBreaker](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L122>)

```go
func CircuitBreaker(threshold int, timeout time.Duration) Middleware
```

CircuitBreaker adds circuit breaker pattern.

<a name="ErrorHandler"></a>
### func [ErrorHandler](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L241>)

```go
func ErrorHandler(handler func(error) error) Middleware
```

ErrorHandler adds custom error handling.

<a name="Logging"></a>
### func [Logging](<https://github.com/agentstation/pocket/blob/master/middleware/logging.go#L12>)

```go
func Logging(logger pocket.Logger) Middleware
```

Logging adds structured logging to a node's lifecycle.

<a name="Metrics"></a>
### func [Metrics](<https://github.com/agentstation/pocket/blob/master/middleware/metrics.go#L17>)

```go
func Metrics(collector MetricsCollector) Middleware
```

Metrics adds comprehensive metrics collection to a node.

<a name="RateLimit"></a>
### func [RateLimit](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L73>)

```go
func RateLimit(rps, burst int) Middleware
```

RateLimit adds rate limiting to a node using a token bucket.

<a name="Retry"></a>
### func [Retry](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L13>)

```go
func Retry(maxAttempts int, backoff time.Duration) Middleware
```

Retry adds retry logic with exponential backoff.

<a name="Timeout"></a>
### func [Timeout](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L43>)

```go
func Timeout(duration time.Duration) Middleware
```

Timeout adds timeout to node execution.

<a name="Timing"></a>
### func [Timing](<https://github.com/agentstation/pocket/blob/master/middleware/timing.go#L12>)

```go
func Timing() Middleware
```

Timing adds execution timing to a node, storing metrics in the store.

<a name="Transform"></a>
### func [Transform](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L210>)

```go
func Transform(transformInput, transformOutput func(any) any) Middleware
```

Transform adds input/output transformation.

<a name="Validation"></a>
### func [Validation](<https://github.com/agentstation/pocket/blob/master/middleware/patterns.go#L174>)

```go
func Validation(validateInput, validateOutput func(any) error) Middleware
```

Validation adds input/output validation.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->