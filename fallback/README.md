# Fallback Package

The `fallback` package provides resilience patterns for Pocket workflows including circuit breakers, retry policies, and fallback chains. It helps build fault-tolerant workflows that gracefully handle failures.

## Features

- **Circuit breaker pattern** implementation
- **Configurable retry policies** with backoff
- **Fallback chains** for degraded operation
- **Timeout handling** with context support
- **Error classification** for smart retries

## Usage Example

```go
import "github.com/agentstation/pocket/fallback"

// Create circuit breaker
cb := fallback.NewCircuitBreaker("external-api",
    fallback.WithMaxFailures(3),
    fallback.WithResetTimeout(30*time.Second),
    fallback.WithOnStateChange(func(from, to string) {
        log.Printf("Circuit breaker state: %s -> %s", from, to)
    }),
)

// Wrap node with circuit breaker
protected := cb.Wrap(node)

// Create fallback chain
chain := fallback.NewChain(
    primaryNode,
    fallback.WithFallback(secondaryNode),
    fallback.WithFallback(cacheNode),
    fallback.WithDefault(defaultValue),
)
```

## Retry Policies

```go
// Exponential backoff
policy := fallback.ExponentialBackoff(
    fallback.WithInitialDelay(100*time.Millisecond),
    fallback.WithMaxDelay(10*time.Second),
    fallback.WithMultiplier(2),
)

// Custom retry policy
customPolicy := fallback.RetryPolicy{
    MaxAttempts: 5,
    ShouldRetry: func(err error) bool {
        // Only retry on transient errors
        return errors.Is(err, ErrTransient)
    },
    NextDelay: func(attempt int) time.Duration {
        return time.Duration(attempt) * time.Second
    },
}
```

## Circuit Breaker States

The circuit breaker follows these state transitions:

```
CLOSED -> OPEN (on failure threshold)
OPEN -> HALF_OPEN (after reset timeout)
HALF_OPEN -> CLOSED (on success)
HALF_OPEN -> OPEN (on failure)
```

## Best Practices

1. **Use circuit breakers** for external service calls
2. **Configure appropriate timeouts** to prevent hanging
3. **Implement fallback strategies** for critical paths
4. **Monitor circuit breaker metrics** for operational insight
5. **Test failure scenarios** to validate resilience

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# fallback

```go
import "github.com/agentstation/pocket/fallback"
```

Package fallback provides circuit breaker pattern implementation.

Package fallback provides fallback mechanisms for pocket workflows including circuit breakers and sophisticated fallback chains.

## Index

- [func ToCircuitBreakerNode\(name string, primary pocket.ExecFunc, fallback Handler, opts ...CircuitOption\) pocket.Node](<#ToCircuitBreakerNode>)
- [func ToNode\(policy Policy\) pocket.Node](<#ToNode>)
- [type AdaptiveChain](<#AdaptiveChain>)
  - [func NewAdaptiveChain\(name string, learningRate float64\) \*AdaptiveChain](<#NewAdaptiveChain>)
  - [func \(a \*AdaptiveChain\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#AdaptiveChain.Execute>)
- [type CachedFallbackPolicy](<#CachedFallbackPolicy>)
  - [func NewCachedFallbackPolicy\(name string, primary pocket.ExecFunc, cacheKey func\(any\) string\) \*CachedFallbackPolicy](<#NewCachedFallbackPolicy>)
  - [func \(p \*CachedFallbackPolicy\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#CachedFallbackPolicy.Execute>)
  - [func \(p \*CachedFallbackPolicy\) Name\(\) string](<#CachedFallbackPolicy.Name>)
  - [func \(p \*CachedFallbackPolicy\) WithStaleOK\(ok bool\) \*CachedFallbackPolicy](<#CachedFallbackPolicy.WithStaleOK>)
  - [func \(p \*CachedFallbackPolicy\) WithTTL\(ttl time.Duration\) \*CachedFallbackPolicy](<#CachedFallbackPolicy.WithTTL>)
- [type Chain](<#Chain>)
  - [func NewChain\(name string\) \*Chain](<#NewChain>)
  - [func \(c \*Chain\) AddLink\(link Link\) \*Chain](<#Chain.AddLink>)
  - [func \(c \*Chain\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#Chain.Execute>)
  - [func \(c \*Chain\) GetMetrics\(\) MetricsSnapshot](<#Chain.GetMetrics>)
  - [func \(c \*Chain\) WithStrategy\(strategy Strategy\) \*Chain](<#Chain.WithStrategy>)
- [type ChainOption](<#ChainOption>)
  - [func CollectErrors\(\) ChainOption](<#CollectErrors>)
  - [func StopOnFirstSuccess\(\) ChainOption](<#StopOnFirstSuccess>)
  - [func WithTimeout\(d time.Duration\) ChainOption](<#WithTimeout>)
- [type ChainPolicy](<#ChainPolicy>)
  - [func NewChainPolicy\(name string, handlers \[\]pocket.ExecFunc, opts ...ChainOption\) \*ChainPolicy](<#NewChainPolicy>)
  - [func \(p \*ChainPolicy\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#ChainPolicy.Execute>)
  - [func \(p \*ChainPolicy\) Name\(\) string](<#ChainPolicy.Name>)
- [type CircuitBreaker](<#CircuitBreaker>)
  - [func NewCircuitBreaker\(name string, opts ...CircuitOption\) \*CircuitBreaker](<#NewCircuitBreaker>)
  - [func \(cb \*CircuitBreaker\) Execute\(ctx context.Context, store pocket.Store, fn pocket.ExecFunc, input any\) \(any, error\)](<#CircuitBreaker.Execute>)
  - [func \(cb \*CircuitBreaker\) GetMetrics\(\) CircuitMetrics](<#CircuitBreaker.GetMetrics>)
  - [func \(cb \*CircuitBreaker\) GetState\(\) CircuitState](<#CircuitBreaker.GetState>)
- [type CircuitBreakerGroup](<#CircuitBreakerGroup>)
  - [func NewCircuitBreakerGroup\(\) \*CircuitBreakerGroup](<#NewCircuitBreakerGroup>)
  - [func \(g \*CircuitBreakerGroup\) Get\(name string, opts ...CircuitOption\) \*CircuitBreaker](<#CircuitBreakerGroup.Get>)
  - [func \(g \*CircuitBreakerGroup\) GetAllMetrics\(\) \[\]CircuitMetrics](<#CircuitBreakerGroup.GetAllMetrics>)
  - [func \(g \*CircuitBreakerGroup\) Reset\(\)](<#CircuitBreakerGroup.Reset>)
- [type CircuitBreakerPolicy](<#CircuitBreakerPolicy>)
  - [func NewCircuitBreakerPolicy\(name string, primary pocket.ExecFunc, fallback Handler, opts ...CircuitOption\) \*CircuitBreakerPolicy](<#NewCircuitBreakerPolicy>)
  - [func \(p \*CircuitBreakerPolicy\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#CircuitBreakerPolicy.Execute>)
  - [func \(p \*CircuitBreakerPolicy\) Name\(\) string](<#CircuitBreakerPolicy.Name>)
- [type CircuitMetrics](<#CircuitMetrics>)
- [type CircuitOption](<#CircuitOption>)
  - [func WithHalfOpenRequests\(n int\) CircuitOption](<#WithHalfOpenRequests>)
  - [func WithMaxFailures\(n int\) CircuitOption](<#WithMaxFailures>)
  - [func WithResetTimeout\(d time.Duration\) CircuitOption](<#WithResetTimeout>)
  - [func WithStateChangeCallback\(fn func\(from, to CircuitState\)\) CircuitOption](<#WithStateChangeCallback>)
- [type CircuitState](<#CircuitState>)
  - [func \(s CircuitState\) String\(\) string](<#CircuitState.String>)
- [type Handler](<#Handler>)
- [type Link](<#Link>)
- [type LinkStats](<#LinkStats>)
- [type Metrics](<#Metrics>)
- [type MetricsSnapshot](<#MetricsSnapshot>)
- [type ParallelStrategy](<#ParallelStrategy>)
  - [func NewParallelStrategy\(timeout time.Duration\) \*ParallelStrategy](<#NewParallelStrategy>)
  - [func \(s \*ParallelStrategy\) Execute\(ctx context.Context, chain \*Chain, store pocket.Store, input any\) \(any, error\)](<#ParallelStrategy.Execute>)
- [type Policy](<#Policy>)
- [type PolicyBuilder](<#PolicyBuilder>)
  - [func NewPolicyBuilder\(name string\) \*PolicyBuilder](<#NewPolicyBuilder>)
  - [func \(b \*PolicyBuilder\) Add\(policy Policy\) \*PolicyBuilder](<#PolicyBuilder.Add>)
  - [func \(b \*PolicyBuilder\) Build\(\) Policy](<#PolicyBuilder.Build>)
- [type SequentialStrategy](<#SequentialStrategy>)
  - [func \(s \*SequentialStrategy\) Execute\(ctx context.Context, chain \*Chain, store pocket.Store, input any\) \(any, error\)](<#SequentialStrategy.Execute>)
- [type SimplePolicy](<#SimplePolicy>)
  - [func NewSimplePolicy\(name string, primary pocket.ExecFunc, fallback Handler\) \*SimplePolicy](<#NewSimplePolicy>)
  - [func \(p \*SimplePolicy\) Execute\(ctx context.Context, store pocket.Store, input any\) \(any, error\)](<#SimplePolicy.Execute>)
  - [func \(p \*SimplePolicy\) Name\(\) string](<#SimplePolicy.Name>)
- [type Strategy](<#Strategy>)
- [type WeightedRandomStrategy](<#WeightedRandomStrategy>)
  - [func NewWeightedRandomStrategy\(maxAttempts int\) \*WeightedRandomStrategy](<#NewWeightedRandomStrategy>)
  - [func \(s \*WeightedRandomStrategy\) Execute\(ctx context.Context, chain \*Chain, store pocket.Store, input any\) \(any, error\)](<#WeightedRandomStrategy.Execute>)


<a name="ToCircuitBreakerNode"></a>
## func [ToCircuitBreakerNode](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L333>)

```go
func ToCircuitBreakerNode(name string, primary pocket.ExecFunc, fallback Handler, opts ...CircuitOption) pocket.Node
```

ToNode converts a circuit breaker policy to a pocket Node.

<a name="ToNode"></a>
## func [ToNode](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L353>)

```go
func ToNode(policy Policy) pocket.Node
```

ToNode converts a fallback policy to a pocket Node.

<a name="AdaptiveChain"></a>
## type [AdaptiveChain](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L348-L351>)

AdaptiveChain automatically adjusts link weights based on success rates.

```go
type AdaptiveChain struct {
    *Chain
    // contains filtered or unexported fields
}
```

<a name="NewAdaptiveChain"></a>
### func [NewAdaptiveChain](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L354>)

```go
func NewAdaptiveChain(name string, learningRate float64) *AdaptiveChain
```

NewAdaptiveChain creates a chain that learns from execution history.

<a name="AdaptiveChain.Execute"></a>
### func \(\*AdaptiveChain\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L362>)

```go
func (a *AdaptiveChain) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs the chain and updates weights based on results.

<a name="CachedFallbackPolicy"></a>
## type [CachedFallbackPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L216-L222>)

CachedFallbackPolicy uses cached results as fallback.

```go
type CachedFallbackPolicy struct {
    // contains filtered or unexported fields
}
```

<a name="NewCachedFallbackPolicy"></a>
### func [NewCachedFallbackPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L225>)

```go
func NewCachedFallbackPolicy(name string, primary pocket.ExecFunc, cacheKey func(any) string) *CachedFallbackPolicy
```

NewCachedFallbackPolicy creates a policy that falls back to cached results.

<a name="CachedFallbackPolicy.Execute"></a>
### func \(\*CachedFallbackPolicy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L253>)

```go
func (p *CachedFallbackPolicy) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs with cache fallback support.

<a name="CachedFallbackPolicy.Name"></a>
### func \(\*CachedFallbackPolicy\) [Name](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L248>)

```go
func (p *CachedFallbackPolicy) Name() string
```

Name returns the policy name.

<a name="CachedFallbackPolicy.WithStaleOK"></a>
### func \(\*CachedFallbackPolicy\) [WithStaleOK](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L242>)

```go
func (p *CachedFallbackPolicy) WithStaleOK(ok bool) *CachedFallbackPolicy
```

WithStaleOK allows serving stale cache on failure.

<a name="CachedFallbackPolicy.WithTTL"></a>
### func \(\*CachedFallbackPolicy\) [WithTTL](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L236>)

```go
func (p *CachedFallbackPolicy) WithTTL(ttl time.Duration) *CachedFallbackPolicy
```

WithTTL sets the cache TTL.

<a name="Chain"></a>
## type [Chain](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L13-L19>)

Chain represents a sophisticated fallback chain with advanced features.

```go
type Chain struct {
    // contains filtered or unexported fields
}
```

<a name="NewChain"></a>
### func [NewChain](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L46>)

```go
func NewChain(name string) *Chain
```

NewChain creates a new fallback chain.

<a name="Chain.AddLink"></a>
### func \(\*Chain\) [AddLink](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L61>)

```go
func (c *Chain) AddLink(link Link) *Chain
```

AddLink adds a link to the chain.

<a name="Chain.Execute"></a>
### func \(\*Chain\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L82>)

```go
func (c *Chain) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs the fallback chain.

<a name="Chain.GetMetrics"></a>
### func \(\*Chain\) [GetMetrics](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L91>)

```go
func (c *Chain) GetMetrics() MetricsSnapshot
```

GetMetrics returns chain execution metrics.

<a name="Chain.WithStrategy"></a>
### func \(\*Chain\) [WithStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L73>)

```go
func (c *Chain) WithStrategy(strategy Strategy) *Chain
```

WithStrategy sets the execution strategy.

<a name="ChainOption"></a>
## type [ChainOption](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L73>)

ChainOption configures a chain policy.

```go
type ChainOption func(*chainOptions)
```

<a name="CollectErrors"></a>
### func [CollectErrors](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L83>)

```go
func CollectErrors() ChainOption
```

CollectErrors stores all errors encountered.

<a name="StopOnFirstSuccess"></a>
### func [StopOnFirstSuccess](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L76>)

```go
func StopOnFirstSuccess() ChainOption
```

StopOnFirstSuccess stops the chain when a handler succeeds.

<a name="WithTimeout"></a>
### func [WithTimeout](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L90>)

```go
func WithTimeout(d time.Duration) ChainOption
```

WithTimeout sets a timeout for the entire chain.

<a name="ChainPolicy"></a>
## type [ChainPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L60-L64>)

ChainPolicy executes a chain of handlers until one succeeds.

```go
type ChainPolicy struct {
    // contains filtered or unexported fields
}
```

<a name="NewChainPolicy"></a>
### func [NewChainPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L97>)

```go
func NewChainPolicy(name string, handlers []pocket.ExecFunc, opts ...ChainOption) *ChainPolicy
```

NewChainPolicy creates a chain fallback policy.

<a name="ChainPolicy.Execute"></a>
### func \(\*ChainPolicy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L119>)

```go
func (p *ChainPolicy) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs the chain of handlers.

<a name="ChainPolicy.Name"></a>
### func \(\*ChainPolicy\) [Name](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L114>)

```go
func (p *ChainPolicy) Name() string
```

Name returns the policy name.

<a name="CircuitBreaker"></a>
## type [CircuitBreaker](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L40-L65>)

CircuitBreaker implements the circuit breaker pattern.

```go
type CircuitBreaker struct {
    // contains filtered or unexported fields
}
```

<a name="NewCircuitBreaker"></a>
### func [NewCircuitBreaker](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L99>)

```go
func NewCircuitBreaker(name string, opts ...CircuitOption) *CircuitBreaker
```

NewCircuitBreaker creates a new circuit breaker.

<a name="CircuitBreaker.Execute"></a>
### func \(\*CircuitBreaker\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L116>)

```go
func (cb *CircuitBreaker) Execute(ctx context.Context, store pocket.Store, fn pocket.ExecFunc, input any) (any, error)
```

Execute runs the given function through the circuit breaker.

<a name="CircuitBreaker.GetMetrics"></a>
### func \(\*CircuitBreaker\) [GetMetrics](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L261>)

```go
func (cb *CircuitBreaker) GetMetrics() CircuitMetrics
```

GetMetrics returns circuit breaker metrics.

<a name="CircuitBreaker.GetState"></a>
### func \(\*CircuitBreaker\) [GetState](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L254>)

```go
func (cb *CircuitBreaker) GetState() CircuitState
```

GetState returns the current circuit state.

<a name="CircuitBreakerGroup"></a>
## type [CircuitBreakerGroup](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L356-L359>)

CircuitBreakerGroup manages multiple circuit breakers.

```go
type CircuitBreakerGroup struct {
    // contains filtered or unexported fields
}
```

<a name="NewCircuitBreakerGroup"></a>
### func [NewCircuitBreakerGroup](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L362>)

```go
func NewCircuitBreakerGroup() *CircuitBreakerGroup
```

NewCircuitBreakerGroup creates a new circuit breaker group.

<a name="CircuitBreakerGroup.Get"></a>
### func \(\*CircuitBreakerGroup\) [Get](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L369>)

```go
func (g *CircuitBreakerGroup) Get(name string, opts ...CircuitOption) *CircuitBreaker
```

Get returns a circuit breaker by name, creating it if necessary.

<a name="CircuitBreakerGroup.GetAllMetrics"></a>
### func \(\*CircuitBreakerGroup\) [GetAllMetrics](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L394>)

```go
func (g *CircuitBreakerGroup) GetAllMetrics() []CircuitMetrics
```

GetAllMetrics returns metrics for all circuit breakers in the group.

<a name="CircuitBreakerGroup.Reset"></a>
### func \(\*CircuitBreakerGroup\) [Reset](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L407>)

```go
func (g *CircuitBreakerGroup) Reset()
```

Reset resets all circuit breakers in the group.

<a name="CircuitBreakerPolicy"></a>
## type [CircuitBreakerPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L290-L295>)

CircuitBreakerPolicy wraps an exec function with circuit breaker protection.

```go
type CircuitBreakerPolicy struct {
    // contains filtered or unexported fields
}
```

<a name="NewCircuitBreakerPolicy"></a>
### func [NewCircuitBreakerPolicy](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L298>)

```go
func NewCircuitBreakerPolicy(name string, primary pocket.ExecFunc, fallback Handler, opts ...CircuitOption) *CircuitBreakerPolicy
```

NewCircuitBreakerPolicy creates a policy with circuit breaker protection.

<a name="CircuitBreakerPolicy.Execute"></a>
### func \(\*CircuitBreakerPolicy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L313>)

```go
func (p *CircuitBreakerPolicy) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs with circuit breaker protection.

<a name="CircuitBreakerPolicy.Name"></a>
### func \(\*CircuitBreakerPolicy\) [Name](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L308>)

```go
func (p *CircuitBreakerPolicy) Name() string
```

Name returns the policy name.

<a name="CircuitMetrics"></a>
## type [CircuitMetrics](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L278-L287>)

CircuitMetrics contains circuit breaker statistics.

```go
type CircuitMetrics struct {
    Name            string
    State           string
    TotalRequests   int64
    TotalSuccesses  int64
    TotalFailures   int64
    CircuitOpens    int64
    LastOpenTime    time.Time
    CurrentFailures int
}
```

<a name="CircuitOption"></a>
## type [CircuitOption](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L68>)

CircuitOption configures a circuit breaker.

```go
type CircuitOption func(*CircuitBreaker)
```

<a name="WithHalfOpenRequests"></a>
### func [WithHalfOpenRequests](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L85>)

```go
func WithHalfOpenRequests(n int) CircuitOption
```

WithHalfOpenRequests sets the number of test requests in half\-open state.

<a name="WithMaxFailures"></a>
### func [WithMaxFailures](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L71>)

```go
func WithMaxFailures(n int) CircuitOption
```

WithMaxFailures sets the failure threshold.

<a name="WithResetTimeout"></a>
### func [WithResetTimeout](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L78>)

```go
func WithResetTimeout(d time.Duration) CircuitOption
```

WithResetTimeout sets the timeout before attempting recovery.

<a name="WithStateChangeCallback"></a>
### func [WithStateChangeCallback](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L92>)

```go
func WithStateChangeCallback(fn func(from, to CircuitState)) CircuitOption
```

WithStateChangeCallback sets a callback for state transitions.

<a name="CircuitState"></a>
## type [CircuitState](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L14>)

CircuitState represents the state of a circuit breaker.

```go
type CircuitState int
```

<a name="StateClosed"></a>

```go
const (
    // StateClosed allows requests to pass through.
    StateClosed CircuitState = iota
    // StateOpen blocks all requests.
    StateOpen
    // StateHalfOpen allows limited requests to test recovery.
    StateHalfOpen
)
```

<a name="CircuitState.String"></a>
### func \(CircuitState\) [String](<https://github.com/agentstation/pocket/blob/master/fallback/circuit.go#L26>)

```go
func (s CircuitState) String() string
```

String returns the string representation of the circuit state.

<a name="Handler"></a>
## type [Handler](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L22>)

Handler is a function that can serve as a fallback.

```go
type Handler func(ctx context.Context, store pocket.StoreWriter, input any, err error) (any, error)
```

<a name="Link"></a>
## type [Link](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L22-L28>)

Link represents a single link in the fallback chain.

```go
type Link struct {
    Name      string
    Handler   pocket.ExecFunc
    Weight    float64
    Condition func(ctx context.Context, store pocket.Store, input any) bool
    Transform func(input any) any
}
```

<a name="LinkStats"></a>
## type [LinkStats](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L128-L133>)

LinkStats contains statistics for a single link.

```go
type LinkStats struct {
    Executions int64
    Successes  int64
    Failures   int64
    AvgLatency time.Duration
}
```

<a name="Metrics"></a>
## type [Metrics](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L36-L43>)

Metrics tracks chain execution metrics.

```go
type Metrics struct {
    // contains filtered or unexported fields
}
```

<a name="MetricsSnapshot"></a>
## type [MetricsSnapshot](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L122-L125>)

MetricsSnapshot represents a point\-in\-time view of metrics.

```go
type MetricsSnapshot struct {
    TotalExecutions int64
    LinkStats       map[string]LinkStats
}
```

<a name="ParallelStrategy"></a>
## type [ParallelStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L194-L196>)

ParallelStrategy executes links concurrently and returns the first success.

```go
type ParallelStrategy struct {
    // contains filtered or unexported fields
}
```

<a name="NewParallelStrategy"></a>
### func [NewParallelStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L199>)

```go
func NewParallelStrategy(timeout time.Duration) *ParallelStrategy
```

NewParallelStrategy creates a parallel execution strategy.

<a name="ParallelStrategy.Execute"></a>
### func \(\*ParallelStrategy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L203>)

```go
func (s *ParallelStrategy) Execute(ctx context.Context, chain *Chain, store pocket.Store, input any) (any, error)
```



<a name="Policy"></a>
## type [Policy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L14-L19>)

Policy defines a fallback strategy.

```go
type Policy interface {
    // Execute runs the primary function with fallback support.
    Execute(ctx context.Context, store pocket.Store, input any) (any, error)
    // Name returns the policy name.
    Name() string
}
```

<a name="PolicyBuilder"></a>
## type [PolicyBuilder](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L292-L295>)

PolicyBuilder helps construct complex fallback policies.

```go
type PolicyBuilder struct {
    // contains filtered or unexported fields
}
```

<a name="NewPolicyBuilder"></a>
### func [NewPolicyBuilder](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L324>)

```go
func NewPolicyBuilder(name string) *PolicyBuilder
```

NewPolicyBuilder creates a new policy builder.

<a name="PolicyBuilder.Add"></a>
### func \(\*PolicyBuilder\) [Add](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L332>)

```go
func (b *PolicyBuilder) Add(policy Policy) *PolicyBuilder
```

Add adds a policy to the builder.

<a name="PolicyBuilder.Build"></a>
### func \(\*PolicyBuilder\) [Build](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L338>)

```go
func (b *PolicyBuilder) Build() Policy
```

Build creates a composite policy.

<a name="SequentialStrategy"></a>
## type [SequentialStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L136>)

SequentialStrategy executes links in order until one succeeds.

```go
type SequentialStrategy struct{}
```

<a name="SequentialStrategy.Execute"></a>
### func \(\*SequentialStrategy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L138>)

```go
func (s *SequentialStrategy) Execute(ctx context.Context, chain *Chain, store pocket.Store, input any) (any, error)
```



<a name="SimplePolicy"></a>
## type [SimplePolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L25-L29>)

SimplePolicy provides basic fallback functionality.

```go
type SimplePolicy struct {
    // contains filtered or unexported fields
}
```

<a name="NewSimplePolicy"></a>
### func [NewSimplePolicy](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L32>)

```go
func NewSimplePolicy(name string, primary pocket.ExecFunc, fallback Handler) *SimplePolicy
```

NewSimplePolicy creates a basic fallback policy.

<a name="SimplePolicy.Execute"></a>
### func \(\*SimplePolicy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L46>)

```go
func (p *SimplePolicy) Execute(ctx context.Context, store pocket.Store, input any) (any, error)
```

Execute runs with fallback support.

<a name="SimplePolicy.Name"></a>
### func \(\*SimplePolicy\) [Name](<https://github.com/agentstation/pocket/blob/master/fallback/policy.go#L41>)

```go
func (p *SimplePolicy) Name() string
```

Name returns the policy name.

<a name="Strategy"></a>
## type [Strategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L31-L33>)

Strategy defines how the chain executes.

```go
type Strategy interface {
    Execute(ctx context.Context, chain *Chain, store pocket.Store, input any) (any, error)
}
```

<a name="WeightedRandomStrategy"></a>
## type [WeightedRandomStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L276-L279>)

WeightedRandomStrategy randomly selects links based on weights.

```go
type WeightedRandomStrategy struct {
    // contains filtered or unexported fields
}
```

<a name="NewWeightedRandomStrategy"></a>
### func [NewWeightedRandomStrategy](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L282>)

```go
func NewWeightedRandomStrategy(maxAttempts int) *WeightedRandomStrategy
```

NewWeightedRandomStrategy creates a weighted random strategy.

<a name="WeightedRandomStrategy.Execute"></a>
### func \(\*WeightedRandomStrategy\) [Execute](<https://github.com/agentstation/pocket/blob/master/fallback/chain.go#L289>)

```go
func (s *WeightedRandomStrategy) Execute(ctx context.Context, chain *Chain, store pocket.Store, input any) (any, error)
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->